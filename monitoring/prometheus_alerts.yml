# Prometheus AlertManager Rules for ERC-8004
# Critical alerts for production monitoring

groups:
  - name: erc8004_critical
    interval: 30s
    rules:
      # High error rate alert
      - alert: ERC8004HighErrorRate
        expr: |
          (
            sum(rate(erc8004_agent_registrations_total{status="error"}[5m]))
            /
            sum(rate(erc8004_agent_registrations_total[5m]))
          ) > 0.05
        for: 2m
        labels:
          severity: critical
          component: erc8004
          team: backend
        annotations:
          summary: "High error rate in ERC-8004 agent registrations"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/erc8004-high-error-rate"

      # Slow response time
      - alert: ERC8004SlowResponseTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(erc8004_agent_registration_duration_seconds_bucket[5m])) by (le)
          ) > 2
        for: 5m
        labels:
          severity: warning
          component: erc8004
          team: backend
        annotations:
          summary: "Slow response time for agent registration"
          description: "P95 latency is {{ $value }}s (threshold: 2s)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/erc8004-slow-response"

      # Database connection issues
      - alert: ERC8004DatabaseUnhealthy
        expr: |
          erc8004_health_check{check="database",status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          component: erc8004
          team: infrastructure
        annotations:
          summary: "ERC-8004 database health check failing"
          description: "Database is unreachable or unhealthy"
          runbook_url: "https://docs.kamiyo.ai/runbooks/database-unhealthy"

      # Redis unavailable
      - alert: ERC8004RedisUnhealthy
        expr: |
          erc8004_health_check{check="redis",status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          component: erc8004
          team: infrastructure
        annotations:
          summary: "ERC-8004 Redis health check failing"
          description: "Redis is unreachable (rate limiting and caching affected)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/redis-unhealthy"

      # Stale materialized views
      - alert: ERC8004StaleMaterializedViews
        expr: |
          erc8004_materialized_view_age_seconds > 3600
        for: 10m
        labels:
          severity: warning
          component: erc8004
          team: backend
        annotations:
          summary: "ERC-8004 materialized views are stale"
          description: "Views haven't refreshed in {{ $value | humanizeDuration }} (threshold: 1h)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/stale-materialized-views"

      # No registrations for extended period
      - alert: ERC8004NoRegistrations
        expr: |
          rate(erc8004_agent_registrations_total[30m]) == 0
        for: 2h
        labels:
          severity: warning
          component: erc8004
          team: backend
        annotations:
          summary: "No agent registrations in 2 hours"
          description: "System may be down or experiencing issues"
          runbook_url: "https://docs.kamiyo.ai/runbooks/no-registrations"

      # Rate limit hits (potential DoS)
      - alert: ERC8004HighRateLimitHits
        expr: |
          sum(rate(erc8004_rate_limit_exceeded_total[5m])) > 10
        for: 5m
        labels:
          severity: warning
          component: erc8004
          team: security
        annotations:
          summary: "High rate of rate limit hits"
          description: "{{ $value }} rate limit hits per second (potential DoS)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/rate-limit-hits"

  - name: erc8004_performance
    interval: 1m
    rules:
      # Cache effectiveness
      - alert: ERC8004LowCacheHitRate
        expr: |
          (
            sum(rate(erc8004_cache_hits_total[10m]))
            /
            sum(rate(erc8004_cache_requests_total[10m]))
          ) < 0.6
        for: 10m
        labels:
          severity: info
          component: erc8004
          team: backend
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 60%)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/low-cache-hit-rate"

      # Search query performance
      - alert: ERC8004SlowSearchQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(erc8004_agent_search_duration_seconds_bucket[5m])) by (le)
          ) > 0.5
        for: 10m
        labels:
          severity: info
          component: erc8004
          team: backend
        annotations:
          summary: "Slow agent search queries"
          description: "P95 search latency is {{ $value }}s (threshold: 500ms)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/slow-search"

      # High transaction rollback rate
      - alert: ERC8004HighRollbackRate
        expr: |
          (
            sum(rate(erc8004_database_rollbacks_total[5m]))
            /
            sum(rate(erc8004_database_transactions_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: erc8004
          team: backend
        annotations:
          summary: "High database transaction rollback rate"
          description: "Rollback rate is {{ $value | humanizePercentage }} (threshold: 10%)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/high-rollback-rate"

  - name: erc8004_capacity
    interval: 1m
    rules:
      # API request volume spike
      - alert: ERC8004HighRequestVolume
        expr: |
          sum(rate(erc8004_api_requests_total[5m])) > 1000
        for: 10m
        labels:
          severity: warning
          component: erc8004
          team: infrastructure
        annotations:
          summary: "High API request volume"
          description: "Receiving {{ $value }} requests/second (may need scaling)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/high-request-volume"

      # Active agents growth
      - alert: ERC8004RapidAgentGrowth
        expr: |
          increase(erc8004_active_agents_total[1h]) > 1000
        for: 1h
        labels:
          severity: info
          component: erc8004
          team: product
        annotations:
          summary: "Rapid growth in active agents"
          description: "{{ $value }} new agents in the last hour"
          runbook_url: "https://docs.kamiyo.ai/runbooks/rapid-growth"

  - name: erc8004_security
    interval: 30s
    rules:
      # Authentication failures
      - alert: ERC8004HighAuthFailureRate
        expr: |
          sum(rate(erc8004_auth_failures_total[5m])) > 5
        for: 5m
        labels:
          severity: warning
          component: erc8004
          team: security
        annotations:
          summary: "High authentication failure rate"
          description: "{{ $value }} auth failures per second (potential brute force)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/auth-failures"

      # Unusual feedback patterns
      - alert: ERC8004SuspiciousFeedbackActivity
        expr: |
          sum(rate(erc8004_feedback_submissions_total[5m])) > 100
        for: 10m
        labels:
          severity: info
          component: erc8004
          team: security
        annotations:
          summary: "Unusually high feedback submission rate"
          description: "{{ $value }} feedback submissions per second (review for abuse)"
          runbook_url: "https://docs.kamiyo.ai/runbooks/suspicious-feedback"

# Inhibition rules (prevent alert spam)
inhibit_rules:
  # If database is down, don't alert on dependent issues
  - source_match:
      alertname: ERC8004DatabaseUnhealthy
    target_match_re:
      alertname: "ERC8004.*"
    equal:
      - component

  # If Redis is down, don't alert on caching issues
  - source_match:
      alertname: ERC8004RedisUnhealthy
    target_match:
      alertname: ERC8004LowCacheHitRate
    equal:
      - component

# Route configuration (where to send alerts)
route:
  receiver: 'default'
  group_by: ['alertname', 'component']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    # Critical alerts go to PagerDuty
    - match:
        severity: critical
      receiver: 'pagerduty'
      continue: true

    # Security alerts go to security team
    - match:
        team: security
      receiver: 'security-team'

    # Infrastructure alerts
    - match:
        team: infrastructure
      receiver: 'infrastructure-team'

    # Product/analytics alerts
    - match:
        team: product
      receiver: 'product-team'

# Receivers (notification destinations)
receivers:
  - name: 'default'
    slack_configs:
      - api_url: '{{ env "SLACK_WEBHOOK_URL" }}'
        channel: '#alerts-erc8004'
        title: 'ERC-8004 Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: '{{ env "PAGERDUTY_SERVICE_KEY" }}'
        description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'

  - name: 'security-team'
    slack_configs:
      - api_url: '{{ env "SLACK_WEBHOOK_URL" }}'
        channel: '#security-alerts'
    email_configs:
      - to: 'security@kamiyo.ai'

  - name: 'infrastructure-team'
    slack_configs:
      - api_url: '{{ env "SLACK_WEBHOOK_URL" }}'
        channel: '#infrastructure'

  - name: 'product-team'
    slack_configs:
      - api_url: '{{ env "SLACK_WEBHOOK_URL" }}'
        channel: '#product-metrics'
