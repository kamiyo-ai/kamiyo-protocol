#!/usr/bin/env python3
"""
Agent 1: Exploit Monitor
Real-time monitoring of exploit disclosure sources
"""

import os
import json
import requests
from datetime import datetime, timedelta
from pathlib import Path

class ExploitMonitor:
    """Monitor real-time exploit disclosures"""

    def __init__(self):
        self.sources = {
            'rekt_news': 'https://rekt.news/leaderboard.json',
            'defillama_hacks': 'https://api.llama.fi/hacks',
        }
        self.output_dir = Path('intelligence/exploits')
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def fetch_rekt_news(self):
        """Fetch from Rekt News leaderboard"""
        try:
            print("üì° Fetching from Rekt News...")
            response = requests.get(self.sources['rekt_news'], timeout=10)

            if response.status_code == 200:
                data = response.json()
                exploits = []

                for entry in data[:20]:  # Top 20
                    exploit = {
                        'source': 'rekt_news',
                        'protocol': entry.get('name', 'Unknown'),
                        'amount_usd': entry.get('funds_lost', 0),
                        'date': entry.get('date', ''),
                        'category': entry.get('category', 'Unknown'),
                        'url': f"https://rekt.news/{entry.get('slug', '')}",
                        'fetched_at': datetime.now().isoformat()
                    }
                    exploits.append(exploit)

                print(f"‚úÖ Fetched {len(exploits)} exploits from Rekt News")
                return exploits
            else:
                print(f"‚ö†Ô∏è Rekt News returned status {response.status_code}")
                return []
        except Exception as e:
            print(f"‚ùå Error fetching Rekt News: {e}")
            return []

    def fetch_defillama_hacks(self):
        """Fetch from DeFiLlama Hacks API"""
        try:
            print("üì° Fetching from DeFiLlama...")
            response = requests.get(self.sources['defillama_hacks'], timeout=10)

            if response.status_code == 200:
                data = response.json()
                exploits = []

                # Filter recent exploits (last 12 months)
                cutoff_date = datetime.now() - timedelta(days=365)

                for entry in data:
                    try:
                        # Parse date
                        date_str = entry.get('date', '')
                        if date_str:
                            # Handle different date formats
                            for fmt in ['%m/%d/%Y', '%Y-%m-%d', '%d/%m/%Y']:
                                try:
                                    entry_date = datetime.strptime(date_str, fmt)
                                    break
                                except:
                                    continue
                            else:
                                continue  # Skip if date can't be parsed

                            if entry_date < cutoff_date:
                                continue  # Too old

                        exploit = {
                            'source': 'defillama',
                            'protocol': entry.get('name', 'Unknown'),
                            'amount_usd': entry.get('amount', 0),
                            'date': date_str,
                            'chain': entry.get('chain', 'Unknown'),
                            'technique': entry.get('technique', 'Unknown'),
                            'classification': entry.get('classification', 'Unknown'),
                            'url': entry.get('url', ''),
                            'fetched_at': datetime.now().isoformat()
                        }
                        exploits.append(exploit)
                    except Exception as e:
                        continue  # Skip problematic entries

                print(f"‚úÖ Fetched {len(exploits)} recent exploits from DeFiLlama")
                return exploits
            else:
                print(f"‚ö†Ô∏è DeFiLlama returned status {response.status_code}")
                return []
        except Exception as e:
            print(f"‚ùå Error fetching DeFiLlama: {e}")
            return []

    def save_exploits(self, exploits):
        """Save exploits to database"""
        output_file = self.output_dir / f'exploits_{datetime.now().strftime("%Y%m%d")}.json'

        # Merge with existing if file exists
        existing = []
        if output_file.exists():
            try:
                with open(output_file) as f:
                    existing = json.load(f)
            except:
                pass

        # Deduplicate by protocol name
        all_exploits = existing + exploits
        unique_exploits = {e['protocol']: e for e in all_exploits}.values()

        with open(output_file, 'w') as f:
            json.dump(list(unique_exploits), f, indent=2)

        print(f"üíæ Saved {len(unique_exploits)} unique exploits to {output_file}")
        return len(unique_exploits)

    def run(self):
        """Run monitoring cycle"""
        print("="*70)
        print("EXPLOIT MONITOR - AGENT 1")
        print("="*70)

        all_exploits = []

        # Fetch from all sources
        all_exploits.extend(self.fetch_rekt_news())
        all_exploits.extend(self.fetch_defillama_hacks())

        # Save to database
        total = self.save_exploits(all_exploits)

        # Generate summary
        summary = {
            'total_exploits': total,
            'sources_monitored': len(self.sources),
            'last_update': datetime.now().isoformat(),
            'top_exploits': sorted(
                all_exploits,
                key=lambda x: x.get('amount_usd', 0),
                reverse=True
            )[:10]
        }

        summary_file = self.output_dir / 'monitor_summary.json'
        with open(summary_file, 'w') as f:
            json.dump(summary, f, indent=2)

        print(f"\n‚úÖ Monitoring complete:")
        print(f"   Total exploits tracked: {total}")
        print(f"   Top exploit: {summary['top_exploits'][0]['protocol']} (${summary['top_exploits'][0]['amount_usd']:,.0f})")
        print(f"   Summary: {summary_file}")

        return summary

if __name__ == '__main__':
    monitor = ExploitMonitor()
    monitor.run()
