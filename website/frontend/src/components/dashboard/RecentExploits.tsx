/**
 * RecentExploits Component
 * Displays live feed of latest exploits with filtering and sorting
 */

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  TrendingDown,
  AlertTriangle,
  ExternalLink,
  Filter,
  ArrowUpDown,
} from 'lucide-react';
import { Exploit } from '@/types';
import { apiClient } from '@/api/client';
import { useWebSocketExploits } from '@/hooks/useWebSocket';
import LoadingSpinner from '@/components/common/LoadingSpinner';
import { formatDistance } from 'date-fns';

type SortField = 'timestamp' | 'amount_usd' | 'protocol';
type SortOrder = 'asc' | 'desc';

export const RecentExploits: React.FC = () => {
  const [exploits, setExploits] = useState<Exploit[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedChain, setSelectedChain] = useState<string>('all');
  const [sortField, setSortField] = useState<SortField>('timestamp');
  const [sortOrder, setSortOrder] = useState<SortOrder>('desc');
  const [chains, setChains] = useState<string[]>([]);

  // WebSocket updates
  const newExploit = useWebSocketExploits();

  // Fetch initial exploits
  useEffect(() => {
    fetchExploits();
    fetchChains();
  }, []);

  // Add new exploit from WebSocket
  useEffect(() => {
    if (newExploit) {
      setExploits((prev) => [newExploit, ...prev].slice(0, 50));
    }
  }, [newExploit]);

  const fetchExploits = async () => {
    try {
      setIsLoading(true);
      const response = await apiClient.get('/exploits', {
        params: {
          page: 1,
          page_size: 50,
        },
      });
      setExploits(response.data.data);
    } catch (error) {
      console.error('Failed to fetch exploits:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchChains = async () => {
    try {
      const response = await apiClient.get('/chains');
      setChains(response.data.chains.map((c: any) => c.chain));
    } catch (error) {
      console.error('Failed to fetch chains:', error);
    }
  };

  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortOrder('desc');
    }
  };

  const filteredAndSortedExploits = exploits
    .filter((exploit) => selectedChain === 'all' || exploit.chain === selectedChain)
    .sort((a, b) => {
      let comparison = 0;
      switch (sortField) {
        case 'timestamp':
          comparison = new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
          break;
        case 'amount_usd':
          comparison = a.amount_usd - b.amount_usd;
          break;
        case 'protocol':
          comparison = a.protocol.localeCompare(b.protocol);
          break;
      }
      return sortOrder === 'asc' ? comparison : -comparison;
    });

  const getSeverity = (amount: number): 'low' | 'medium' | 'high' | 'critical' => {
    if (amount >= 10000000) return 'critical';
    if (amount >= 1000000) return 'high';
    if (amount >= 100000) return 'medium';
    return 'low';
  };

  const formatAmount = (amount: number): string => {
    if (amount >= 1000000) {
      return `$${(amount / 1000000).toFixed(2)}M`;
    }
    if (amount >= 1000) {
      return `$${(amount / 1000).toFixed(0)}K`;
    }
    return `$${amount.toFixed(0)}`;
  };

  if (isLoading) {
    return (
      <div className="recent-exploits-loading">
        <LoadingSpinner size="lg" text="Loading exploits..." />
      </div>
    );
  }

  return (
    <div className="recent-exploits">
      <div className="exploits-header">
        <div className="header-title">
          <TrendingDown size={24} />
          <h2>Recent Exploits</h2>
          <span className="exploit-count">{filteredAndSortedExploits.length}</span>
        </div>

        <div className="header-controls">
          <div className="chain-filter">
            <Filter size={16} />
            <select
              value={selectedChain}
              onChange={(e) => setSelectedChain(e.target.value)}
              className="filter-select"
            >
              <option value="all">All Chains</option>
              {chains.map((chain) => (
                <option key={chain} value={chain}>
                  {chain}
                </option>
              ))}
            </select>
          </div>
        </div>
      </div>

      <div className="exploits-table">
        <table>
          <thead>
            <tr>
              <th>Severity</th>
              <th>
                <button onClick={() => handleSort('timestamp')} className="sort-btn">
                  Time
                  {sortField === 'timestamp' && <ArrowUpDown size={14} />}
                </button>
              </th>
              <th>
                <button onClick={() => handleSort('protocol')} className="sort-btn">
                  Protocol
                  {sortField === 'protocol' && <ArrowUpDown size={14} />}
                </button>
              </th>
              <th>Chain</th>
              <th>Attack Type</th>
              <th>
                <button onClick={() => handleSort('amount_usd')} className="sort-btn">
                  Loss (USD)
                  {sortField === 'amount_usd' && <ArrowUpDown size={14} />}
                </button>
              </th>
              <th>Source</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <AnimatePresence initial={false}>
              {filteredAndSortedExploits.map((exploit, index) => (
                <motion.tr
                  key={exploit.tx_hash}
                  initial={{ opacity: 0, y: -20 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: 20 }}
                  transition={{ duration: 0.3, delay: index * 0.02 }}
                  className="exploit-row"
                >
                  <td>
                    <span
                      className={`severity-badge severity-${getSeverity(
                        exploit.amount_usd
                      )}`}
                    >
                      <AlertTriangle size={14} />
                      {getSeverity(exploit.amount_usd)}
                    </span>
                  </td>
                  <td className="time-cell">
                    {formatDistance(new Date(exploit.timestamp), new Date(), {
                      addSuffix: true,
                    })}
                  </td>
                  <td className="protocol-cell">{exploit.protocol}</td>
                  <td>
                    <span className="chain-badge">{exploit.chain}</span>
                  </td>
                  <td className="attack-type-cell">{exploit.attack_type}</td>
                  <td className="amount-cell">{formatAmount(exploit.amount_usd)}</td>
                  <td className="source-cell">
                    <span className="source-badge">{exploit.source}</span>
                  </td>
                  <td>
                    <a
                      href={`/exploits/${exploit.tx_hash}`}
                      className="details-link"
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      <ExternalLink size={16} />
                    </a>
                  </td>
                </motion.tr>
              ))}
            </AnimatePresence>
          </tbody>
        </table>

        {filteredAndSortedExploits.length === 0 && (
          <div className="no-exploits">
            <AlertTriangle size={40} />
            <p>No exploits found matching your filters</p>
          </div>
        )}
      </div>
    </div>
  );
};

export default RecentExploits;
