#!/usr/bin/env python3
"""
Post the latest exploit >= $1M to social media
One-time script to trigger immediate posting
"""
import os
import sys
import asyncio
from datetime import datetime
from dotenv import load_dotenv

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# Load environment
load_dotenv()

# Import required modules
from social.kamiyo_watcher import KamiyoWatcher
from social.autonomous_growth_engine import AutonomousGrowthEngine
from social.models import Platform

async def post_latest_exploit():
    """Find and post the latest exploit >= $1M"""

    print("\n" + "="*60)
    print("KAMIYO - Post Latest Exploit")
    print("="*60)

    # Social media config (same as in kamiyo_watcher.py)
    social_config = {
        'x_twitter': {
            'enabled': os.getenv('X_TWITTER_ENABLED', 'false').lower() == 'true',
            'api_key': os.getenv('X_API_KEY'),
            'api_secret': os.getenv('X_API_SECRET'),
            'access_token': os.getenv('X_ACCESS_TOKEN'),
            'access_secret': os.getenv('X_ACCESS_SECRET'),
            'bearer_token': os.getenv('X_BEARER_TOKEN')
        }
    }

    print("\n[1/4] Initializing Autonomous Growth Engine...")

    # Use production API
    api_url = 'https://api.kamiyo.ai'

    # Initialize autonomous growth engine for deep dive analysis
    engine = AutonomousGrowthEngine(
        social_config=social_config,
        kamiyo_api_url=api_url,
        kamiyo_api_key=os.getenv('KAMIYO_API_KEY'),
        enable_monitoring=False,
        enable_alerting=False
    )

    print("‚úÖ Engine initialized with Claude AI deep dive analysis")

    # Initialize watcher with autonomous engine callback
    watcher = KamiyoWatcher(
        api_base_url=api_url,
        social_poster=engine.social_poster,
        api_key=os.getenv('KAMIYO_API_KEY'),
        process_callback=engine.process_exploit  # Use autonomous engine for deep dive
    )

    print("\n[2/4] Fetching recent exploits from API...")

    # Fetch recent exploits (no time filter - get all recent ones)
    exploits = watcher.fetch_recent_exploits()

    if not exploits:
        print("‚ùå No exploits found >= $1M")
        return

    print(f"‚úÖ Found {len(exploits)} exploits >= $1M")

    # Get the latest one
    latest = exploits[0]

    print(f"\n[3/4] Latest exploit details:")
    print(f"  Protocol: {latest.get('protocol', 'Unknown')}")
    print(f"  Chain: {latest.get('chain', 'Unknown')}")
    print(f"  Amount: ${latest.get('amount_usd', 0):,.0f}")
    print(f"  Date: {latest.get('timestamp', 'Unknown')}")
    print(f"  TX Hash: {latest.get('tx_hash', 'Unknown')[:20]}...")

    # Convert to ExploitData
    exploit_data = watcher.convert_to_exploit_data(latest)

    # Check if already posted
    print(f"\n[4/4] Posting to social media...")
    if exploit_data.tx_hash in watcher.posted_tx_hashes:
        print(f"‚ö†Ô∏è  This exploit was already posted")
        print(f"   Forcing re-post anyway...")
        watcher.posted_tx_hashes.discard(exploit_data.tx_hash)

    # Post it using the autonomous engine
    try:
        result = engine.process_exploit(
            exploit_data,
            platforms=[Platform.X_TWITTER],
            auto_post=True
        )

        if result['success'] or result.get('partial'):
            print("\n" + "="*60)
            print("‚úÖ SUCCESS - Exploit posted!")
            print("="*60)
            print(f"\nCheck https://x.com/KamiyoAI for the post")

            if exploit_data.loss_amount_usd >= 1_000_000:
                print(f"\nüßµ This was a DEEP DIVE thread (Claude AI analysis)")
                print(f"   Expected: 8-10 tweets with detailed analysis")
        else:
            print("\n‚ùå Failed to post exploit")
            print(f"Error: {result.get('reason') or result.get('error', 'Unknown error')}")

    except Exception as e:
        print(f"\n‚ùå Error posting: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(post_latest_exploit())
