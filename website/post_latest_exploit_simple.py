#!/usr/bin/env python3
"""
Post the latest exploit >= $1M to X/Twitter
Simple one-time trigger script
"""
import os
import sys
import asyncio
import httpx
from dotenv import load_dotenv

# Load environment
load_dotenv()

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from social.kamiyo_watcher import KamiyoWatcher
from social.poster import SocialMediaPoster

async def main():
    print("\n" + "="*60)
    print("KAMIYO - Post Latest Exploit to X/Twitter")
    print("="*60)
    
    # Configuration
    api_url = os.getenv('KAMIYO_API_URL', 'https://api.kamiyo.ai')
    threshold = 1_000_000  # $1M
    
    print(f"\n[1/5] Configuration:")
    print(f"  API: {api_url}")
    print(f"  Threshold: ${threshold:,}")
    
    # Configure social media (X/Twitter only)
    social_config = {
        'x_twitter': {
            'enabled': os.getenv('X_TWITTER_ENABLED', 'false').lower() == 'true',
            'api_key': os.getenv('X_API_KEY'),
            'api_secret': os.getenv('X_API_SECRET'),
            'access_token': os.getenv('X_ACCESS_TOKEN'),
            'access_secret': os.getenv('X_ACCESS_SECRET'),
            'bearer_token': os.getenv('X_BEARER_TOKEN')
        }
    }
    
    if not social_config['x_twitter']['enabled']:
        print("\n‚ùå X/Twitter is not enabled!")
        print("   Set X_TWITTER_ENABLED=true in .env")
        return
    
    print(f"  X/Twitter: ‚úì Enabled")
    
    # Initialize poster
    poster = SocialMediaPoster(social_config)
    
    # Initialize watcher
    watcher = KamiyoWatcher(
        api_base_url=api_url,
        social_poster=poster,
        min_amount_usd=threshold
    )
    
    print(f"\n[2/5] Fetching recent exploits...")
    
    # Fetch exploits from API
    async with httpx.AsyncClient() as client:
        try:
            response = await client.get(
                f"{api_url}/exploits",
                params={
                    'page': 1,
                    'page_size': 100,
                    'min_amount': threshold
                },
                timeout=30.0
            )
            response.raise_for_status()
            data = response.json()
            
        except Exception as e:
            print(f"\n‚ùå Failed to fetch exploits: {e}")
            return
    
    exploits = data.get('data', [])
    
    if not exploits:
        print(f"\n‚ùå No exploits found >= ${threshold:,}")
        return
    
    print(f"  ‚úì Found {len(exploits)} exploit(s)")
    
    # Get the latest one
    latest = exploits[0]
    
    print(f"\n[3/5] Latest exploit:")
    print(f"  Protocol: {latest.get('protocol', 'Unknown')}")
    print(f"  Chain: {latest.get('chain', 'Unknown')}")
    print(f"  Amount: ${latest.get('amount_usd', 0):,.0f}")
    print(f"  Date: {latest.get('timestamp', 'Unknown')}")
    print(f"  TX: {latest.get('tx_hash', 'Unknown')[:20]}...")
    
    # Check if already posted
    print(f"\n[4/5] Checking if already posted...")
    tx_hash = latest.get('tx_hash')
    
    if await watcher._is_posted(tx_hash):
        print(f"  ‚ö†Ô∏è  Already posted - will force repost anyway")
    else:
        print(f"  ‚úì Not posted yet")
    
    # Post it!
    print(f"\n[5/5] Posting to X/Twitter...")
    print(f"  This will generate a Claude AI deep dive thread...")
    
    try:
        # Process and post the exploit
        result = await watcher._process_and_post_exploit(latest)
        
        if result:
            print("\n" + "="*60)
            print("‚úÖ SUCCESS - Posted to X/Twitter!")
            print("="*60)
            print(f"\nCheck: https://x.com/KamiyoAI")
            print(f"\nüßµ This was a deep dive thread with Claude AI analysis")
            print(f"   (${latest.get('amount_usd', 0):,.0f} >= ${threshold:,})")
        else:
            print("\n‚ùå Failed to post")
            
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(main())
