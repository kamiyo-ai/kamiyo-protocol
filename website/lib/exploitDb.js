// lib/exploitDb.js
// Direct access to the exploit intelligence database
import Database from 'better-sqlite3';
import path from 'path';

let db = null;

export function getExploitDb() {
    if (!db) {
        // Try multiple possible database locations
        const possiblePaths = [
            process.env.EXPLOIT_DB_PATH,
            path.join(process.cwd(), 'data', 'kamiyo.db'),
            path.join(process.cwd(), '..', 'data', 'kamiyo.db'),
            '/Users/dennisgoslar/Projekter/kamiyo/data/kamiyo.db'
        ].filter(Boolean);

        let dbPath = null;
        for (const testPath of possiblePaths) {
            try {
                const fs = require('fs');
                if (fs.existsSync(testPath)) {
                    dbPath = testPath;
                    break;
                }
            } catch (err) {
                // Try next path
            }
        }

        if (!dbPath) {
            throw new Error(`Exploit database not found. Tried: ${possiblePaths.join(', ')}`);
        }

        console.log('[ExploitDB] Opening database at:', dbPath);
        db = new Database(dbPath, { readonly: true });
    }
    return db;
}

export function getStats(days = 7) {
    const db = getExploitDb();

    // Get stats for the specified period
    const periodStats = db.prepare(`
        SELECT
            COUNT(*) as count,
            COALESCE(SUM(amount_usd), 0) as total_loss
        FROM exploits
        WHERE timestamp >= datetime('now', '-' || ? || ' days')
    `).get(days);

    // Get total counts
    const totals = db.prepare(`
        SELECT
            COUNT(*) as total_exploits,
            COUNT(DISTINCT chain) as chains_tracked
        FROM exploits
    `).get();

    return {
        total_exploits: totals.total_exploits,
        total_loss_usd: periodStats.total_loss,
        period_exploits: periodStats.count,
        period_days: days,
        average_per_day: periodStats.count > 0 ? Math.round(periodStats.total_loss / days) : 0,
        chains_tracked: totals.chains_tracked
    };
}

export function getHealthStats() {
    const db = getExploitDb();

    const totals = db.prepare(`
        SELECT
            COUNT(*) as database_exploits,
            COUNT(DISTINCT chain) as tracked_chains
        FROM exploits
    `).get();

    const sources = db.prepare(`
        SELECT
            source as name,
            COUNT(*) as fetch_count,
            MAX(timestamp) as last_fetch,
            1 as is_active
        FROM exploits
        GROUP BY source
    `).all();

    // Total sources we monitor (18 aggregators)
    const TOTAL_MONITORED_SOURCES = 18;

    return {
        database_exploits: totals.database_exploits,
        tracked_chains: totals.tracked_chains,
        active_sources: sources.length,
        total_sources: TOTAL_MONITORED_SOURCES,
        sources: sources.map(s => ({
            ...s,
            error_count: 0,
            success_rate: 100
        }))
    };
}
