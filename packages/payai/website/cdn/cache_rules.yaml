# Kamiyo CDN Cache Rules
# CloudFlare CDN caching strategy for optimal performance

# ============================================================================
# Cache Strategy Overview
# ============================================================================
#
# 1. Static Assets: 1 year cache (immutable)
# 2. API GET Responses: 5 minutes cache (frequently updated)
# 3. API POST/PUT/DELETE: No cache (mutations)
# 4. HTML Pages: 1 hour cache (content pages)
# 5. Webhooks: No cache (real-time)
#
# Performance targets:
# - Cache hit ratio: >90%
# - CDN bandwidth savings: >60%
# - API response time: <50ms (cached)
# ============================================================================

version: '1.0'

# Global cache settings
global:
  # Cache level: aggressive, basic, simplified
  cache_level: aggressive

  # Browser cache TTL (seconds)
  browser_cache_ttl: 3600  # 1 hour

  # Always serve stale content when origin is down
  always_online: true

  # Development mode (bypass cache)
  development_mode: false

# ============================================================================
# Page Rules (Priority Order)
# ============================================================================

page_rules:
  # Rule 1: Static Assets (Highest Priority)
  # Cache CSS, JS, images, fonts for 1 year
  - name: static_assets
    priority: 1
    status: active
    url_pattern: "*.kamiyo.ai/static/*"
    actions:
      cache_level: cache_everything
      edge_cache_ttl: 31536000  # 1 year
      browser_cache_ttl: 31536000  # 1 year
      # Add cache headers
      cache_on_cookie: false
      # Minify assets
      minify:
        html: false
        css: true
        js: true
    description: "Cache static assets (CSS, JS, images) for maximum performance"

  # Rule 2: API Documentation
  # Cache API docs for 1 day
  - name: api_docs
    priority: 2
    status: active
    url_pattern: "*.kamiyo.ai/docs*"
    actions:
      cache_level: cache_everything
      edge_cache_ttl: 86400  # 1 day
      browser_cache_ttl: 3600  # 1 hour
      minify:
        html: true
        css: true
        js: true
    description: "Cache API documentation"

  # Rule 3: API GET Endpoints
  # Cache GET requests for 5 minutes
  - name: api_get_exploits
    priority: 3
    status: active
    url_pattern: "*.kamiyo.ai/api/exploits*"
    actions:
      cache_level: cache_everything
      edge_cache_ttl: 300  # 5 minutes
      browser_cache_ttl: 60  # 1 minute
      # Vary by query string
      cache_by_query_string: all
      # Cache even with cookies
      cache_on_cookie: true
    description: "Cache exploit listings for 5 minutes"

  # Rule 4: API Stats Endpoint
  # Cache stats for 2 minutes
  - name: api_stats
    priority: 4
    status: active
    url_pattern: "*.kamiyo.ai/api/stats*"
    actions:
      cache_level: cache_everything
      edge_cache_ttl: 120  # 2 minutes
      browser_cache_ttl: 60  # 1 minute
      cache_by_query_string: all
    description: "Cache statistics endpoint"

  # Rule 5: API Health Endpoint
  # Very short cache (30 seconds)
  - name: api_health
    priority: 5
    status: active
    url_pattern: "*.kamiyo.ai/api/health*"
    actions:
      cache_level: cache_everything
      edge_cache_ttl: 30  # 30 seconds
      browser_cache_ttl: 0  # No browser cache
    description: "Short cache for health checks"

  # Rule 6: Bypass Cache for Webhooks
  # No caching for real-time webhooks
  - name: webhooks
    priority: 6
    status: active
    url_pattern: "*.kamiyo.ai/api/webhooks/*"
    actions:
      cache_level: bypass
    description: "Bypass cache for webhooks (real-time)"

  # Rule 7: Bypass Cache for Authentication
  # No caching for auth endpoints
  - name: auth
    priority: 7
    status: active
    url_pattern: "*.kamiyo.ai/api/auth/*"
    actions:
      cache_level: bypass
    description: "Bypass cache for authentication"

  # Rule 8: Bypass Cache for User-Specific Data
  # No caching for user dashboards
  - name: user_dashboard
    priority: 8
    status: active
    url_pattern: "*.kamiyo.ai/api/user/*"
    actions:
      cache_level: bypass
    description: "Bypass cache for user-specific data"

  # Rule 9: Bypass Cache for Payment Processing
  # No caching for Stripe operations
  - name: payments
    priority: 9
    status: active
    url_pattern: "*.kamiyo.ai/api/payments/*"
    actions:
      cache_level: bypass
    description: "Bypass cache for payment processing"

  # Rule 10: Default API Caching
  # Short cache for other API endpoints
  - name: api_default
    priority: 10
    status: active
    url_pattern: "*.kamiyo.ai/api/*"
    actions:
      cache_level: cache_everything
      edge_cache_ttl: 60  # 1 minute
      browser_cache_ttl: 30  # 30 seconds
    description: "Default cache for API endpoints"

# ============================================================================
# Content Type Rules
# ============================================================================

content_type_rules:
  # Images
  - content_types:
      - image/jpeg
      - image/png
      - image/gif
      - image/webp
      - image/svg+xml
    edge_cache_ttl: 31536000  # 1 year
    browser_cache_ttl: 31536000  # 1 year
    description: "Cache images for 1 year"

  # Fonts
  - content_types:
      - font/woff
      - font/woff2
      - font/ttf
      - font/otf
    edge_cache_ttl: 31536000  # 1 year
    browser_cache_ttl: 31536000  # 1 year
    description: "Cache fonts for 1 year"

  # CSS
  - content_types:
      - text/css
    edge_cache_ttl: 31536000  # 1 year
    browser_cache_ttl: 31536000  # 1 year
    minify: true
    description: "Cache and minify CSS for 1 year"

  # JavaScript
  - content_types:
      - application/javascript
      - text/javascript
    edge_cache_ttl: 31536000  # 1 year
    browser_cache_ttl: 31536000  # 1 year
    minify: true
    description: "Cache and minify JavaScript for 1 year"

  # JSON (API responses)
  - content_types:
      - application/json
    edge_cache_ttl: 300  # 5 minutes
    browser_cache_ttl: 60  # 1 minute
    description: "Short cache for JSON API responses"

  # HTML
  - content_types:
      - text/html
    edge_cache_ttl: 3600  # 1 hour
    browser_cache_ttl: 1800  # 30 minutes
    minify: true
    description: "Cache and minify HTML for 1 hour"

# ============================================================================
# Purge Strategy
# ============================================================================

purge_strategy:
  # Automatic purge triggers
  auto_purge:
    # Purge on new exploit
    - trigger: new_exploit
      purge_urls:
        - "/api/exploits"
        - "/api/exploits?page=1"
        - "/api/stats"
      description: "Purge exploit listings when new exploit added"

    # Purge on stats update
    - trigger: stats_update
      purge_urls:
        - "/api/stats"
        - "/api/stats?days=1"
        - "/api/stats?days=7"
      description: "Purge stats endpoint on update"

  # Manual purge endpoints
  manual_purge:
    - name: purge_all
      description: "Purge all cache (use sparingly)"
      requires_confirmation: true

    - name: purge_api
      prefix: "/api/"
      description: "Purge all API responses"

    - name: purge_static
      prefix: "/static/"
      description: "Purge static assets (after deployment)"

# ============================================================================
# Cache Tags (Enterprise Feature)
# ============================================================================

cache_tags:
  # Tag exploits by chain
  - name: chain
    pattern: "/api/exploits*"
    extract_from: query_param.chain
    description: "Tag exploits by blockchain"

  # Tag exploits by protocol
  - name: protocol
    pattern: "/api/exploits*"
    extract_from: query_param.protocol
    description: "Tag exploits by protocol"

  # Tag by API version
  - name: api_version
    pattern: "/api/*"
    value: "v1"
    description: "Tag by API version"

# ============================================================================
# Performance Optimization
# ============================================================================

optimization:
  # Brotli compression (better than gzip)
  brotli: true

  # HTTP/2 Server Push
  http2_server_push: true

  # Early Hints (103 status)
  early_hints: true

  # Rocket Loader (async JS loading)
  rocket_loader: false  # Disable if using own async loading

  # Auto Minify
  auto_minify:
    html: true
    css: true
    js: true

  # Mirage (image optimization)
  mirage: true

  # Polish (image compression)
  polish: lossy  # or 'lossless'

# ============================================================================
# Security Settings
# ============================================================================

security:
  # SSL/TLS
  ssl: strict
  min_tls_version: "1.2"

  # Security headers
  headers:
    - name: X-Content-Type-Options
      value: nosniff

    - name: X-Frame-Options
      value: DENY

    - name: X-XSS-Protection
      value: "1; mode=block"

    - name: Strict-Transport-Security
      value: "max-age=31536000; includeSubDomains; preload"

  # Bot management
  bot_management:
    enabled: true
    verified_bots: allow  # Allow Google, Bing, etc.

# ============================================================================
# Monitoring
# ============================================================================

monitoring:
  # Cache analytics
  analytics:
    enabled: true
    sample_rate: 100  # 100% sampling

  # Performance metrics
  metrics:
    - cache_hit_ratio
    - bandwidth_saved
    - response_time_p95
    - error_rate

  # Alerts
  alerts:
    - name: low_cache_hit_ratio
      condition: cache_hit_ratio < 0.8
      action: notify

    - name: high_error_rate
      condition: error_rate > 0.05
      action: notify

# ============================================================================
# Notes
# ============================================================================
#
# Cache Invalidation:
# - Use CloudFlare API to purge cache programmatically
# - Purge by URL, prefix, or tag
# - Consider cache tags for fine-grained control
#
# Best Practices:
# 1. Use versioned URLs for static assets (/static/v1.2.3/app.js)
# 2. Set long cache TTLs for immutable content
# 3. Use short TTLs for frequently changing data
# 4. Bypass cache for user-specific or sensitive data
# 5. Monitor cache hit ratio (target: >90%)
#
# Performance Impact:
# - Cached response: ~50ms
# - Uncached response: ~200ms
# - Bandwidth savings: 60-80%
# ============================================================================
