version: '3.8'

services:
  kamiyo-social:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    image: kamiyo/social:latest
    container_name: kamiyo-social
    restart: unless-stopped

    # Environment variables - use .env file or override
    environment:
      # Kamiyo API Configuration
      KAMIYO_API_URL: ${KAMIYO_API_URL:-https://api.kamiyo.ai}
      KAMIYO_API_KEY: ${KAMIYO_API_KEY}
      KAMIYO_WEBSOCKET_URL: ${KAMIYO_WEBSOCKET_URL:-wss://api.kamiyo.ai/ws}

      # Watcher Configuration
      WATCHER_MODE: ${WATCHER_MODE:-poll}
      POLL_INTERVAL_SECONDS: ${POLL_INTERVAL_SECONDS:-60}
      SOCIAL_MIN_AMOUNT_USD: ${SOCIAL_MIN_AMOUNT_USD:-100000}
      SOCIAL_ENABLED_CHAINS: ${SOCIAL_ENABLED_CHAINS}

      # Reddit Configuration
      REDDIT_ENABLED: ${REDDIT_ENABLED:-false}
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID}
      REDDIT_CLIENT_SECRET: ${REDDIT_CLIENT_SECRET}
      REDDIT_USERNAME: ${REDDIT_USERNAME}
      REDDIT_PASSWORD: ${REDDIT_PASSWORD}
      REDDIT_SUBREDDITS: ${REDDIT_SUBREDDITS:-defi,CryptoCurrency}

      # Discord Configuration
      DISCORD_SOCIAL_ENABLED: ${DISCORD_SOCIAL_ENABLED:-false}
      DISCORD_SOCIAL_WEBHOOKS: ${DISCORD_SOCIAL_WEBHOOKS}

      # Telegram Configuration
      TELEGRAM_SOCIAL_ENABLED: ${TELEGRAM_SOCIAL_ENABLED:-false}
      TELEGRAM_SOCIAL_BOT_TOKEN: ${TELEGRAM_SOCIAL_BOT_TOKEN}
      TELEGRAM_SOCIAL_CHATS: ${TELEGRAM_SOCIAL_CHATS}

      # X/Twitter Configuration
      X_TWITTER_ENABLED: ${X_TWITTER_ENABLED:-false}
      X_API_KEY: ${X_API_KEY}
      X_API_SECRET: ${X_API_SECRET}
      X_ACCESS_TOKEN: ${X_ACCESS_TOKEN}
      X_ACCESS_SECRET: ${X_ACCESS_SECRET}
      X_BEARER_TOKEN: ${X_BEARER_TOKEN}

      # Logging Configuration
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}

      # Monitoring
      SENTRY_DSN: ${SENTRY_DSN}
      PROMETHEUS_ENABLED: ${PROMETHEUS_ENABLED:-false}

    # Volumes for persistence
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data

    # Port mapping for health check endpoint
    ports:
      - "${HEALTH_CHECK_PORT:-8000}:8000"

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Network configuration
    networks:
      - kamiyo-network

  # Optional: Redis for caching and rate limiting
  redis:
    image: redis:7-alpine
    container_name: kamiyo-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - kamiyo-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  kamiyo-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
