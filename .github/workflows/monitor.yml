name: Protocol Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  PROGRAM_ID: 8sUnNU6WBD2SYapCE12S7LwH1b8zWoniytze7ifWwXCM
  PROTOCOL_CONFIG: E6VhYjktLpT91VJy7bt5VL7DhTurZZKZUEFEgxLdZHna
  TREASURY: 8xi4TJcPmLqxmhsbCtNoBcu7b8Lfnubr3GY1bkhjuNJF
  ORACLE_REGISTRY: 2sUcFA5kaxq5akJFw7UzAUizfvZsr72FVpeKWmYc5yuf

jobs:
  health-check:
    name: Protocol Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/v1.18.26/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Check Program Exists
        id: program
        run: |
          RESULT=$(solana account ${{ env.PROGRAM_ID }} --url mainnet-beta --output json 2>&1 || echo "FAILED")
          if echo "$RESULT" | grep -q "FAILED"; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "Program not found or inaccessible"
            exit 1
          fi
          EXECUTABLE=$(echo "$RESULT" | jq -r '.executable')
          if [ "$EXECUTABLE" != "true" ]; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "Program is not executable"
            exit 1
          fi
          echo "status=ok" >> $GITHUB_OUTPUT
          echo "Program is deployed and executable"

      - name: Check Protocol Config
        id: config
        run: |
          RESULT=$(solana account ${{ env.PROTOCOL_CONFIG }} --url mainnet-beta --output json 2>&1 || echo "FAILED")
          if echo "$RESULT" | grep -q "FAILED"; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "Protocol config not found"
            exit 1
          fi
          echo "status=ok" >> $GITHUB_OUTPUT
          echo "Protocol config exists"

      - name: Check Treasury
        id: treasury
        run: |
          BALANCE=$(solana balance ${{ env.TREASURY }} --url mainnet-beta 2>&1 || echo "0")
          echo "Treasury balance: $BALANCE"
          echo "balance=$BALANCE" >> $GITHUB_OUTPUT

      - name: Check Oracle Registry
        id: oracles
        run: |
          RESULT=$(solana account ${{ env.ORACLE_REGISTRY }} --url mainnet-beta --output json 2>&1 || echo "FAILED")
          if echo "$RESULT" | grep -q "FAILED"; then
            echo "status=error" >> $GITHUB_OUTPUT
            echo "Oracle registry not found"
            exit 1
          fi
          # Extract oracle count from account data (offset 0x28, little-endian u32)
          DATA=$(echo "$RESULT" | jq -r '.data[0]')
          ORACLE_COUNT=$(echo "$DATA" | base64 -d | xxd -p -s 40 -l 4 | sed 's/\(..\)\(..\)\(..\)\(..\)/\4\3\2\1/' | xargs printf "%d\n" 0x)
          echo "Oracle count: $ORACLE_COUNT"
          echo "count=$ORACLE_COUNT" >> $GITHUB_OUTPUT
          if [ "$ORACLE_COUNT" -lt 2 ]; then
            echo "Warning: Less than 2 oracles registered"
            exit 1
          fi

      - name: Health Summary
        if: always()
        run: |
          echo "=== Protocol Health Summary ==="
          echo "Program: ${{ steps.program.outputs.status || 'unknown' }}"
          echo "Config: ${{ steps.config.outputs.status || 'unknown' }}"
          echo "Treasury: ${{ steps.treasury.outputs.balance || 'unknown' }}"
          echo "Oracles: ${{ steps.oracles.outputs.count || 'unknown' }}"
          echo "==============================="

      - name: Send Discord Alert on Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "Kamiyo Protocol Alert",
                  "description": "Health check failed. Check GitHub Actions for details.",
                  "color": 16711680,
                  "fields": [
                    {"name": "Program", "value": "${{ steps.program.outputs.status || 'error' }}", "inline": true},
                    {"name": "Config", "value": "${{ steps.config.outputs.status || 'error' }}", "inline": true},
                    {"name": "Oracles", "value": "${{ steps.oracles.outputs.count || 'error' }}", "inline": true}
                  ],
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                }]
              }'
          fi

  devnet-sync-check:
    name: Devnet Sync Check
    runs-on: ubuntu-latest
    steps:
      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/v1.18.26/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Compare Program Hashes
        run: |
          echo "Checking mainnet program..."
          MAINNET_HASH=$(solana account ${{ env.PROGRAM_ID }} --url mainnet-beta --output json 2>/dev/null | jq -r '.data[0]' | md5sum | cut -d' ' -f1 || echo "mainnet-unavailable")

          echo "Checking devnet program..."
          DEVNET_HASH=$(solana account ${{ env.PROGRAM_ID }} --url devnet --output json 2>/dev/null | jq -r '.data[0]' | md5sum | cut -d' ' -f1 || echo "devnet-unavailable")

          echo "Mainnet hash: $MAINNET_HASH"
          echo "Devnet hash: $DEVNET_HASH"

          if [ "$MAINNET_HASH" = "$DEVNET_HASH" ]; then
            echo "Programs are in sync"
          else
            echo "Warning: Programs may be out of sync"
          fi
