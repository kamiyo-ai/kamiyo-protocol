#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
One-time script to post the latest exploit from the database
Usage: python3 social/post_latest_exploit.py
"""

import os
import sys
import logging
from dotenv import load_dotenv

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from social.autonomous_growth_engine import AutonomousGrowthEngine

# Load environment
load_dotenv()

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def main():
    """Post the latest exploit meeting the threshold"""

    # Social media configuration
    social_config = {
        'reddit': {
            'enabled': os.getenv('REDDIT_ENABLED', 'false').lower() == 'true',
            'client_id': os.getenv('REDDIT_CLIENT_ID'),
            'client_secret': os.getenv('REDDIT_CLIENT_SECRET'),
            'username': os.getenv('REDDIT_USERNAME'),
            'password': os.getenv('REDDIT_PASSWORD'),
            'subreddits': os.getenv('REDDIT_SUBREDDITS', 'defi').split(',')
        },
        'discord': {
            'enabled': os.getenv('DISCORD_ENABLED', 'false').lower() == 'true',
            'webhooks': {
                name: url
                for name, url in (
                    item.split('=')
                    for item in os.getenv('DISCORD_SOCIAL_WEBHOOKS', '').split(',')
                    if '=' in item
                )
            }
        },
        'telegram': {
            'enabled': os.getenv('TELEGRAM_SOCIAL_ENABLED', 'false').lower() == 'true',
            'bot_token': os.getenv('TELEGRAM_SOCIAL_BOT_TOKEN'),
            'chat_ids': {
                name: chat_id
                for name, chat_id in (
                    item.split('=')
                    for item in os.getenv('TELEGRAM_SOCIAL_CHATS', '').split(',')
                    if '=' in item
                )
            }
        },
        'x_twitter': {
            'enabled': os.getenv('X_TWITTER_ENABLED', 'false').lower() == 'true',
            'api_key': os.getenv('X_API_KEY'),
            'api_secret': os.getenv('X_API_SECRET'),
            'access_token': os.getenv('X_ACCESS_TOKEN'),
            'access_secret': os.getenv('X_ACCESS_SECRET'),
            'bearer_token': os.getenv('X_BEARER_TOKEN')
        }
    }

    # Check at least one platform enabled
    enabled_platforms = sum(1 for cfg in social_config.values() if cfg.get('enabled'))
    if enabled_platforms == 0:
        logger.error("No social media platforms enabled! Set X_TWITTER_ENABLED=true in .env")
        return

    logger.info(f"Platforms enabled: {enabled_platforms}")

    # Initialize engine
    engine = AutonomousGrowthEngine(
        social_config=social_config,
        kamiyo_api_url=os.getenv('KAMIYO_API_URL', 'https://kamiyo-api.onrender.com'),
        kamiyo_api_key=os.getenv('KAMIYO_API_KEY'),
        enable_monitoring=False,
        enable_alerting=False
    )

    # Fetch latest exploit
    logger.info("Fetching latest exploit from Kamiyo API...")
    min_amount = float(os.getenv('SOCIAL_MIN_AMOUNT_USD', 500000))

    # Temporarily override the watcher's threshold
    engine.watcher.min_amount_usd = min_amount

    exploits = engine.watcher.fetch_recent_exploits()

    if not exploits:
        logger.error("No exploits found meeting threshold")
        return

    logger.info(f"Found {len(exploits)} exploits meeting ${min_amount:,.0f} threshold")

    # Get the most recent one
    latest_exploit_data = exploits[0]
    latest_exploit = engine.watcher.convert_to_exploit_data(latest_exploit_data)

    logger.info(
        f"Latest exploit: {latest_exploit.protocol} "
        f"(${latest_exploit.loss_amount_usd:,.0f}) on {latest_exploit.chain}"
    )

    # Process and post
    logger.info("Processing exploit for social media posting...")
    result = engine.process_exploit(
        latest_exploit,
        platforms=list(engine.social_poster.platforms.keys()),
        auto_post=True
    )

    if result['success']:
        logger.info("✅ Successfully posted exploit to social media!")
        logger.info(f"Stats: {result['stats']}")
    elif result.get('partial'):
        logger.warning("⚠️ Partial success - some platforms failed")
        logger.info(f"Stats: {result['stats']}")
    else:
        logger.error(f"❌ Failed to post: {result.get('error', 'Unknown error')}")

if __name__ == "__main__":
    main()
