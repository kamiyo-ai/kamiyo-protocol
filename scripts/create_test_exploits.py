#!/usr/bin/env python3
"""
scripts/create_test_exploits.py
Creates test exploits with recent timestamps for beta testing tier functionality.

This script adds exploits within the last 24 hours to validate:
- Pro tier gets real-time data (exploits from last 24 hours)
- Free tier gets 24-hour delayed data (exploits older than 24 hours)
"""

import sqlite3
from datetime import datetime, timedelta
import random

DB_PATH = '/Users/dennisgoslar/Projekter/kamiyo/data/kamiyo.db'

def create_test_exploits():
    """Create test exploits with timestamps within the last 24 hours."""

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    print('Creating test exploits for tier validation...\n')

    # Get current time
    now = datetime.utcnow()

    # Test exploits with various recent timestamps
    test_exploits = [
        {
            'tx_hash': '0xtest1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab1',
            'chain': 'Ethereum',
            'protocol': 'Test DeFi Protocol Alpha',
            'amount_usd': 2500000.00,
            'timestamp': now - timedelta(hours=2),  # 2 hours ago
            'source': 'BlockSec',
            'source_url': 'https://twitter.com/BlockSecTeam/status/test1',
            'category': 'Flash Loan',
            'description': 'Test exploit: Flash loan attack on lending protocol',
            'recovery_status': 'investigating'
        },
        {
            'tx_hash': '0xtest1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab2',
            'chain': 'BSC',
            'protocol': 'Test DeFi Protocol Beta',
            'amount_usd': 850000.00,
            'timestamp': now - timedelta(hours=6),  # 6 hours ago
            'source': 'PeckShield',
            'source_url': 'https://twitter.com/PeckShieldAlert/status/test2',
            'category': 'Reentrancy',
            'description': 'Test exploit: Reentrancy vulnerability in staking contract',
            'recovery_status': 'investigating'
        },
        {
            'tx_hash': '0xtest1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab3',
            'chain': 'Arbitrum',
            'protocol': 'Test Bridge Protocol',
            'amount_usd': 4200000.00,
            'timestamp': now - timedelta(hours=12),  # 12 hours ago
            'source': 'CertiK',
            'source_url': 'https://twitter.com/CertiKAlert/status/test3',
            'category': 'Bridge Exploit',
            'description': 'Test exploit: Cross-chain bridge vulnerability',
            'recovery_status': 'funds_returned'
        },
        {
            'tx_hash': '0xtest1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab4',
            'chain': 'Polygon',
            'protocol': 'Test NFT Marketplace',
            'amount_usd': 320000.00,
            'timestamp': now - timedelta(hours=18),  # 18 hours ago
            'source': 'Rekt News',
            'source_url': 'https://rekt.news/test-exploit-4',
            'category': 'Access Control',
            'description': 'Test exploit: Admin key compromise on NFT marketplace',
            'recovery_status': 'investigating'
        },
        {
            'tx_hash': '0xtest1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab5',
            'chain': 'Optimism',
            'protocol': 'Test Yield Aggregator',
            'amount_usd': 1100000.00,
            'timestamp': now - timedelta(hours=23),  # 23 hours ago
            'source': 'BlockSec',
            'source_url': 'https://twitter.com/BlockSecTeam/status/test5',
            'category': 'Logic Error',
            'description': 'Test exploit: Logic error in yield calculation',
            'recovery_status': 'investigating'
        },
        {
            'tx_hash': '0xtest1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab6',
            'chain': 'Ethereum',
            'protocol': 'Test DAO Treasury',
            'amount_usd': 6700000.00,
            'timestamp': now - timedelta(minutes=45),  # 45 minutes ago (very recent!)
            'source': 'PeckShield',
            'source_url': 'https://twitter.com/PeckShieldAlert/status/test6',
            'category': 'Governance',
            'description': 'Test exploit: Malicious governance proposal executed',
            'recovery_status': 'investigating'
        }
    ]

    inserted = 0
    skipped = 0

    for exploit in test_exploits:
        try:
            # Check if exploit already exists
            cursor.execute('SELECT id FROM exploits WHERE tx_hash = ?', (exploit['tx_hash'],))
            if cursor.fetchone():
                print(f'✓ Exploit {exploit["protocol"]} already exists')
                skipped += 1
                continue

            # Insert exploit
            cursor.execute('''
                INSERT INTO exploits (
                    tx_hash, chain, protocol, amount_usd, timestamp,
                    source, source_url, category, description, recovery_status
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                exploit['tx_hash'],
                exploit['chain'],
                exploit['protocol'],
                exploit['amount_usd'],
                exploit['timestamp'].strftime('%Y-%m-%d %H:%M:%S'),
                exploit['source'],
                exploit['source_url'],
                exploit['category'],
                exploit['description'],
                exploit['recovery_status']
            ))

            hours_ago = (now - exploit['timestamp']).total_seconds() / 3600
            print(f'✓ Created exploit: {exploit["protocol"]}')
            print(f'  Chain: {exploit["chain"]} | Amount: ${exploit["amount_usd"]:,.2f}')
            print(f'  Timestamp: {hours_ago:.1f} hours ago')
            print()
            inserted += 1

        except Exception as e:
            print(f'✗ Error creating exploit {exploit["protocol"]}: {e}')

    conn.commit()
    conn.close()

    print(f'\n✅ Test exploits created successfully!')
    print(f'   Inserted: {inserted}')
    print(f'   Skipped (already exist): {skipped}')
    print(f'\nThese recent exploits will be:')
    print(f'  • Visible to Pro/Team/Enterprise users (real-time)')
    print(f'  • Hidden from Free users (24-hour delay)')
    print(f'\nTo validate:')
    print(f'  1. Sign in as free@test.kamiyo.ai (Free tier)')
    print(f'  2. Dashboard should NOT show these exploits')
    print(f'  3. Sign in as pro@test.kamiyo.ai (Pro tier)')
    print(f'  4. Dashboard SHOULD show these exploits')

if __name__ == '__main__':
    create_test_exploits()
