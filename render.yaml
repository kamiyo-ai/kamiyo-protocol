databases:
  - name: kamiyo-postgres
    databaseName: kamiyo
    user: kamiyo
    plan: starter

services:
  # FastAPI Backend
  - type: web
    name: kamiyo-api
    runtime: python
    branch: main
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn api.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PYTHON_VERSION
        value: 3.11
      - key: ENVIRONMENT
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: kamiyo-postgres
          property: connectionString
      - key: ALLOWED_ORIGINS
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_PUBLISHABLE_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: ADMIN_API_KEY
        sync: false
    healthCheckPath: /health

  # Next.js Frontend
  - type: web
    name: kamiyo-frontend
    runtime: node
    branch: main
    buildCommand: npm install && npx prisma generate && npx prisma migrate deploy && npm run build
    startCommand: npm start
    disk:
      name: kamiyo-data
      mountPath: /opt/render/project/src/data
      sizeGB: 1
    envVars:
      - key: NODE_VERSION
        value: 18.20.8
      - key: PORT
        value: 3000
      - key: DATABASE_URL
        fromDatabase:
          name: kamiyo-postgres
          property: connectionString
      - key: EXPLOIT_DB_PATH
        value: /opt/render/project/src/data/kamiyo.db
      - key: NEXT_PUBLIC_API_URL
        fromService:
          type: web
          name: kamiyo-api
          envVarKey: RENDER_EXTERNAL_URL
      - key: NEXT_PUBLIC_API_ENDPOINT
        fromService:
          type: web
          name: kamiyo-api
          envVarKey: RENDER_EXTERNAL_URL
      - key: NEXTAUTH_URL
        sync: false
      - key: NEXTAUTH_SECRET
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        sync: false
    healthCheckPath: /

  # Exploit Aggregation Orchestrator (Fetches from 17+ sources)
  - type: worker
    name: kamiyo-aggregator
    runtime: python
    branch: main
    buildCommand: pip install -r requirements.txt
    startCommand: python3 -u -c "from aggregators.orchestrator import AggregationOrchestrator; import logging; logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'); o = AggregationOrchestrator(); o.run_forever(interval_minutes=5)"
    envVars:
      - key: PYTHON_VERSION
        value: 3.11
      - key: ENVIRONMENT
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: kamiyo-postgres
          property: connectionString

  # Autonomous Growth Engine (Social Media Bot)
  - type: worker
    name: kamiyo-social-bot
    runtime: python
    branch: main
    buildCommand: pip install -r requirements.txt
    startCommand: python3 social/autonomous_growth_engine.py --mode poll
    envVars:
      - key: PYTHON_VERSION
        value: 3.11
      - key: ENVIRONMENT
        value: production
      - key: KAMIYO_API_URL
        value: https://api.kamiyo.ai
      # Social posting intervals and thresholds
      - key: POLL_INTERVAL_SECONDS
        value: 300  # Check every 5 minutes
      - key: SOCIAL_MIN_AMOUNT_USD
        value: 20000000  # $20M minimum - ONLY post major exploits
      - key: DEEP_DIVE_THRESHOLD_USD
        value: 20000000  # $20M minimum for deep dive threads (same as min = always deep dive)
      - key: MAX_POSTS_PER_CYCLE
        value: 3  # Max exploits to post per 5-minute cycle (prevents rate limits)
      # Twitter/X credentials
      - key: X_TWITTER_ENABLED
        sync: false
      - key: X_API_KEY
        sync: false
      - key: X_API_SECRET
        sync: false
      - key: X_ACCESS_TOKEN
        sync: false
      - key: X_ACCESS_SECRET
        sync: false
      # Reddit credentials (optional)
      - key: REDDIT_ENABLED
        sync: false
      - key: REDDIT_CLIENT_ID
        sync: false
      - key: REDDIT_CLIENT_SECRET
        sync: false
      - key: REDDIT_USERNAME
        sync: false
      - key: REDDIT_PASSWORD
        sync: false
      - key: REDDIT_SUBREDDITS
        value: CryptoCurrency,defi,ethereum,ethdev
      # Discord credentials (optional) - Uses webhooks for posting
      - key: DISCORD_ENABLED
        sync: false
      - key: DISCORD_SOCIAL_WEBHOOKS
        sync: false
        # Format: channel_name=webhook_url,another_channel=another_url
        # Example: exploits=https://discord.com/api/webhooks/...
